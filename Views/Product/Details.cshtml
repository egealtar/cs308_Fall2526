@model CS308Main.Models.Product

@{
    ViewData["Title"] = Model.Name;
    var comments = ViewBag.Comments as List<CS308Main.Models.Comment> ?? new List<CS308Main.Models.Comment>();
    var averageRating = ViewBag.AverageRating as double? ?? 0;
    var ratingCount = ViewBag.RatingCount as int? ?? 0;
    var deliveredOrders = ViewBag.DeliveredOrders as List<CS308Main.Models.Order> ?? new List<CS308Main.Models.Order>();
}

<div class="container mt-5">
    <div class="row">
        <!-- Product Image -->
        <div class="col-md-6">
            <div class="card shadow">
                @if (!string.IsNullOrEmpty(Model.ImagePath))
                {
                    <img src="@Model.ImagePath" class="card-img-top" alt="@Model.Name" style="max-height: 500px; object-fit: cover;" />
                }
                else
                {
                    <div class="bg-secondary text-white d-flex align-items-center justify-content-center" style="height: 500px;">
                        <i class="bi bi-image" style="font-size: 5rem;"></i>
                    </div>
                }
            </div>
        </div>

        <!-- Product Info -->
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-body">
                    <h2 class="card-title">@Model.Name</h2>

                    <!-- Rating -->
                    @if (ratingCount > 0)
                    {
                        <div class="mb-3">
                            <div class="d-flex align-items-center">
                                @for (int i = 1; i <= 5; i++)
                                {
                                    if (i <= Math.Floor(averageRating))
                                    {
                                        <i class="bi bi-star-fill text-warning"></i>
                                    }
                                    else if (i - 0.5 <= averageRating)
                                    {
                                        <i class="bi bi-star-half text-warning"></i>
                                    }
                                    else
                                    {
                                        <i class="bi bi-star text-warning"></i>
                                    }
                                }
                                <span class="ms-2 text-muted">@averageRating.ToString("F1") (@ratingCount reviews)</span>
                            </div>
                        </div>
                    }

                    <!-- Price -->
                    <div class="mb-3">
                        @if (Model.HasDiscount)
                        {
                            <div>
                                <span class="badge bg-danger mb-2">-@Model.DiscountPercentage% OFF</span>
                                <div>
                                    <span class="h4 text-decoration-line-through text-muted">$@Model.Price.ToString("F2")</span>
                                    <span class="h3 text-danger ms-2">$@Model.FinalPrice.ToString("F2")</span>
                                </div>
                            </div>
                        }
                        else
                        {
                            <span class="h3 text-success">$@Model.Price.ToString("F2")</span>
                        }
                    </div>

                    <!-- Description -->
                    <p class="card-text">@Model.Description</p>

                    <!-- Specifications -->
                    <div class="card bg-light mb-3">
                        <div class="card-body">
                            <h6 class="card-title fw-bold">Specifications</h6>
                            <ul class="list-unstyled mb-0">
                                <li><strong>Model:</strong> @Model.Model</li>
                                <li><strong>Serial Number:</strong> @Model.SerialNumber</li>
                                <li><strong>Category:</strong> @Model.Category</li>
                                <li><strong>Warranty:</strong> @(Model.WarrantyStatus ? "Yes" : "No")</li>
                                <li><strong>Distributor:</strong> @Model.DistributorInformation</li>
                                <li><strong>Stock:</strong> 
                                    @if (Model.QuantityInStock > 0)
                                    {
                                        <span class="badge bg-success">@Model.QuantityInStock units</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-danger">Out of Stock</span>
                                    }
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Purchase Options -->
            <div class="card shadow mt-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Purchase Options</h5>
                </div>
                <div class="card-body">
                    @if (User.Identity?.IsAuthenticated == true && User.IsInRole("Customer"))
                    {
                        <div class="row g-3">
                            <!-- Wish List Button -->
                            <div class="col-md-6">
                                <form asp-controller="WishList" asp-action="AddToWishList" method="post">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="productId" value="@Model.Id" />
                                    <button type="submit" class="btn btn-outline-danger w-100">
                                        <i class="bi bi-heart"></i> Add to Wish List
                                    </button>
                                </form>
                            </div>

                            <!-- Add to Cart Button -->
                            <div class="col-md-6">
                                @if (Model.QuantityInStock > 0)
                                {
                                    <form asp-controller="ShoppingCart" asp-action="AddToCart" method="post">
                                        @Html.AntiForgeryToken()
                                        <div class="input-group">
                                            <input type="hidden" name="productId" value="@Model.Id" />
                                            <input type="number" name="quantity" class="form-control" value="1" min="1" max="@Model.QuantityInStock" />
                                            <button type="submit" class="btn btn-success">
                                                <i class="bi bi-cart-plus"></i> Add to Cart
                                            </button>
                                        </div>
                                    </form>
                                }
                                else
                                {
                                    <button class="btn btn-secondary w-100" disabled>
                                        <i class="bi bi-x-circle"></i> Out of Stock
                                    </button>
                                }
                            </div>
                        </div>
                    }
                    else if (User.Identity?.IsAuthenticated != true)
                    {
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-info-circle"></i> Please <a asp-controller="Account" asp-action="Login" class="alert-link">login</a> to add items to cart or wish list.
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle"></i> Only customers can purchase products.
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Comments and Ratings Section -->
    @if (User.Identity?.IsAuthenticated == true && User.IsInRole("Customer") && deliveredOrders.Any())
    {
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card shadow">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Leave a Review</h5>
                    </div>
                    <div class="card-body">
                        <!-- Rating Form -->
                        <form asp-controller="Comment" asp-action="AddRating" method="post" class="mb-4">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="productId" value="@Model.Id" />
                            
                            <div class="mb-3">
                                <label class="form-label fw-bold">Your Rating</label>
                                <div class="rating-input">
                                    @for (int i = 5; i >= 1; i--)
                                    {
                                        <input type="radio" name="ratingValue" value="@i" id="star@(i)" required />
                                        <label for="star@(i)" class="star">â˜…</label>
                                    }
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">Select Order</label>
                                <select name="orderId" class="form-select" required>
                                    <option value="">-- Select a delivered order --</option>
                                    @foreach (var order in deliveredOrders)
                                    {
                                        <option value="@order.Id">Order @order.Id.Substring(0, 8)... - @order.CreatedAt.ToString("MMM dd, yyyy")</option>
                                    }
                                </select>
                            </div>

                            <button type="submit" class="btn btn-warning">
                                <i class="bi bi-star"></i> Submit Rating
                            </button>
                        </form>

                        <!-- Comment Form -->
                        <form asp-controller="Comment" asp-action="AddComment" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="productId" value="@Model.Id" />
                            
                            <div class="mb-3">
                                <label class="form-label fw-bold">Your Comment</label>
                                <textarea name="text" class="form-control" rows="4" 
                                          placeholder="Share your experience with this product..." required></textarea>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">Select Order</label>
                                <select name="orderId" class="form-select" required>
                                    <option value="">-- Select a delivered order --</option>
                                    @foreach (var order in deliveredOrders)
                                    {
                                        <option value="@order.Id">Order @order.Id.Substring(0, 8)... - @order.CreatedAt.ToString("MMM dd, yyyy")</option>
                                    }
                                </select>
                            </div>

                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-chat"></i> Submit Comment
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Display Comments -->
    @if (comments.Any())
    {
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card shadow">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Customer Reviews</h5>
                    </div>
                    <div class="card-body">
                        @foreach (var comment in comments)
                        {
                            <div class="comment-item border-bottom pb-3 mb-3">
                                <div class="d-flex justify-content-between">
                                    <strong>@comment.UserName</strong>
                                    <small class="text-muted">@comment.CreatedAt.ToString("MMM dd, yyyy")</small>
                                </div>
                                <p class="mb-0 mt-2">@comment.Text</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Styles {
    <style>
        .rating-input {
            direction: rtl;
            display: inline-flex;
            font-size: 2rem;
        }
        .rating-input input[type="radio"] {
            display: none;
        }
        .rating-input label {
            color: #ddd;
            cursor: pointer;
        }
        .rating-input label:hover,
        .rating-input label:hover ~ label,
        .rating-input input[type="radio"]:checked ~ label {
            color: #ffc107;
        }
    </style>
}