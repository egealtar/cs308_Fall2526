@model CS308Main.Models.Product

@{
    ViewData["Title"] = Model.Name;
    var comments = ViewBag.Comments as List<CS308Main.Models.Comment>;
    var averageRating = ViewBag.AverageRating as double?;
    var ratingCount = ViewBag.RatingCount as int?;
    var deliveredOrders = ViewBag.DeliveredOrders as List<CS308Main.Models.Order>;
}

<div class="container mt-5">
    <div class="row">
        <!-- Product Image -->
        <div class="col-md-6">
            @if (!string.IsNullOrEmpty(Model.ImageUrl))
            {
                <img src="@Model.ImageUrl" alt="@Model.Name" class="img-fluid rounded shadow" />
            }
            else
            {
                <div class="bg-secondary text-white d-flex align-items-center justify-content-center rounded" style="height: 400px;">
                    <i class="bi bi-image" style="font-size: 5rem;"></i>
                </div>
            }
        </div>

        <!-- Product Info -->
        <div class="col-md-6">
            <h1 class="mb-3">@Model.Name</h1>
            
            @if (!string.IsNullOrEmpty(Model.Author))
            {
                <p class="text-muted lead">by @Model.Author</p>
            }
            
            <!-- Rating Display -->
            <div class="mb-3">
                <div class="d-flex align-items-center">
                    <div class="stars me-2">
                        @for (int i = 1; i <= 5; i++)
                        {
                            if (i <= Math.Floor(averageRating ?? 0))
                            {
                                <i class="bi bi-star-fill text-warning"></i>
                            }
                            else if (i - (averageRating ?? 0) < 1 && (averageRating ?? 0) > 0)
                            {
                                <i class="bi bi-star-half text-warning"></i>
                            }
                            else
                            {
                                <i class="bi bi-star text-warning"></i>
                            }
                        }
                    </div>
                    <span class="text-muted">@averageRating out of 5 (@ratingCount ratings)</span>
                </div>
            </div>

            <!-- Price -->
            <div class="mb-3">
                @if (Model.HasDiscount)
                {
                    <div>
                        <span class="text-decoration-line-through text-muted h4">$@Model.Price.ToString("F2")</span>
                        <span class="h2 text-danger ms-2">$@Model.FinalPrice.ToString("F2")</span>
                        <span class="badge bg-danger ms-2">-@Model.DiscountPercentage% OFF</span>
                    </div>
                }
                else
                {
                    <span class="h2 text-success">$@Model.Price.ToString("F2")</span>
                }
            </div>

            <div class="mb-3">
                <p><strong>Model:</strong> @Model.Model</p>
                <p><strong>Serial Number:</strong> @Model.SerialNumber</p>
                <p><strong>Category:</strong> @Model.Category</p>
                <p><strong>Warranty:</strong> 
                    @if (Model.WarrantyStatus)
                    {
                        <span class="badge bg-success">Available</span>
                    }
                    else
                    {
                        <span class="badge bg-secondary">Not Available</span>
                    }
                </p>
                <p><strong>Stock Status:</strong> 
                    @if (Model.QuantityInStock > 0)
                    {
                        <span class="badge bg-success">In Stock (@Model.QuantityInStock available)</span>
                    }
                    else
                    {
                        <span class="badge bg-danger">Out of Stock</span>
                    }
                </p>
            </div>

            <div class="mb-4">
                <h5>Description</h5>
                <p>@Model.Description</p>
            </div>

            <div class="mb-3">
                <h5>Distributor Information</h5>
                <p>@Model.DistributorInformation</p>
            </div>

            @if (Model.QuantityInStock > 0)
            {
                <form asp-controller="ShoppingCart" asp-action="AddToCart" method="post">
                    <input type="hidden" name="productId" value="@Model.Id" />
                    <div class="input-group mb-3" style="max-width: 200px;">
                        <span class="input-group-text">Quantity</span>
                        <input type="number" name="quantity" class="form-control" value="1" min="1" max="@Model.QuantityInStock" />
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-cart-plus"></i> Add to Cart
                    </button>
                </form>
            }
            else
            {
                <button class="btn btn-secondary btn-lg" disabled>Out of Stock</button>
            }
        </div>
    </div>

    <hr class="my-5" />

    <!-- RATING & COMMENT SECTION -->
    @if (User.Identity?.IsAuthenticated == true && User.IsInRole("Customer") && deliveredOrders != null && deliveredOrders.Any())
    {
        <div class="row mb-5">
            <div class="col-md-12">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">Rate & Review This Product</h4>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">
                            <i class="bi bi-info-circle"></i> You can rate and review products from your delivered orders.
                        </p>

                        <!-- Rating Form -->
                        <form asp-controller="Comment" asp-action="AddRating" method="post" class="mb-4">
                            <input type="hidden" name="productId" value="@Model.Id" />
                            <div class="mb-3">
                                <label class="form-label fw-bold">Your Rating</label>
                                <div class="rating-input">
                                    <input type="radio" name="score" value="5" id="star5" />
                                    <label for="star5" title="5 stars">★</label>
                                    <input type="radio" name="score" value="4" id="star4" />
                                    <label for="star4" title="4 stars">★</label>
                                    <input type="radio" name="score" value="3" id="star3" />
                                    <label for="star3" title="3 stars">★</label>
                                    <input type="radio" name="score" value="2" id="star2" />
                                    <label for="star2" title="2 stars">★</label>
                                    <input type="radio" name="score" value="1" id="star1" />
                                    <label for="star1" title="1 star">★</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Select Order</label>
                                <select name="orderId" class="form-select" required>
                                    <option value="">-- Select a delivered order --</option>
                                    @foreach (var order in deliveredOrders)
                                    {
                                        <option value="@order.Id">Order from @order.CreatedAt.ToString("MMM dd, yyyy") - $@order.TotalPrice.ToString("F2")</option>
                                    }
                                </select>
                            </div>
                            <button type="submit" class="btn btn-warning">
                                <i class="bi bi-star-fill"></i> Submit Rating
                            </button>
                        </form>

                        <hr />

                        <!-- Comment Form -->
                        <form asp-controller="Comment" asp-action="AddComment" method="post">
                            <input type="hidden" name="productId" value="@Model.Id" />
                            <div class="mb-3">
                                <label class="form-label fw-bold">Your Review</label>
                                <textarea name="text" class="form-control" rows="4" placeholder="Share your experience with this product..." required></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Select Order</label>
                                <select name="orderId" class="form-select" required>
                                    <option value="">-- Select a delivered order --</option>
                                    @foreach (var order in deliveredOrders)
                                    {
                                        <option value="@order.Id">Order from @order.CreatedAt.ToString("MMM dd, yyyy") - $@order.TotalPrice.ToString("F2")</option>
                                    }
                                </select>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-chat-square-text"></i> Submit Review
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    }
    else if (User.Identity?.IsAuthenticated == true && User.IsInRole("Customer"))
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> You can rate and review this product after your order is delivered.
        </div>
    }

    <!-- COMMENTS DISPLAY -->
    <div class="row">
        <div class="col-md-12">
            <h3 class="mb-4">Customer Reviews</h3>
            @if (comments == null || !comments.Any())
            {
                <div class="alert alert-secondary">
                    <i class="bi bi-chat"></i> No reviews yet. Be the first to review this product!
                </div>
            }
            else
            {
                @foreach (var comment in comments)
                {
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <h6 class="card-subtitle mb-2">
                                    <i class="bi bi-person-circle"></i> @comment.UserName
                                </h6>
                                <small class="text-muted">@comment.CreatedAt.ToString("MMM dd, yyyy")</small>
                            </div>
                            <p class="card-text mt-2">@comment.Text</p>
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>

@section Styles {
    <style>
        .rating-input {
            direction: rtl;
            display: inline-flex;
            font-size: 2rem;
        }
        .rating-input input[type="radio"] {
            display: none;
        }
        .rating-input label {
            color: #ddd;
            cursor: pointer;
            padding: 0 5px;
        }
        .rating-input label:hover,
        .rating-input label:hover ~ label,
        .rating-input input[type="radio"]:checked ~ label {
            color: #ffd700;
        }
    </style>
}