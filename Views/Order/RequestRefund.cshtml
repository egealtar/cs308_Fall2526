@model CS308Main.Models.Order

@{
    ViewData["Title"] = "Request Refund";
    var daysRemaining = 30 - (int)(DateTime.UtcNow - Model.CreatedAt).TotalDays;
}

<div class="container mt-5">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h3 class="mb-0">
                        <i class="bi bi-arrow-counterclockwise"></i> Request Refund
                    </h3>
                </div>
                <div class="card-body">
                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            @TempData["Error"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Refund Policy:</strong> You can request a refund within 30 days of purchase. 
                        @if (daysRemaining > 0)
                        {
                            <span>You have <strong>@daysRemaining day(s)</strong> remaining.</span>
                        }
                    </div>

                    <div class="mb-4">
                        <h5>Order Information</h5>
                        <p><strong>Order ID:</strong> @Model.Id</p>
                        <p><strong>Order Date:</strong> @Model.CreatedAt.ToString("MMMM dd, yyyy")</p>
                        <p><strong>Total Amount:</strong> $@Model.TotalPrice.ToString("F2")</p>
                    </div>

                    <form asp-action="RequestRefund" method="post" id="refundForm">
                        <input type="hidden" name="orderId" value="@Model.Id" />

                        <h5 class="mb-3">Select Products to Refund</h5>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Select</th>
                                        <th>Product</th>
                                        <th>Quantity Ordered</th>
                                        <th>Price (at purchase)</th>
                                        <th>Quantity to Refund</th>
                                        <th>Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @for (int i = 0; i < Model.Items.Count; i++)
                                    {
                                        var item = Model.Items[i];
                                        <tr>
                                            <td>
                                                <input type="checkbox" 
                                                       class="form-check-input refund-checkbox" 
                                                       data-product-id="@item.ProductId"
                                                       data-price="@item.Price"
                                                       data-quantity="@item.Quantity"
                                                       onchange="updateRefundQuantity(this, @i)" />
                                            </td>
                                            <td>@item.ProductName</td>
                                            <td>@item.Quantity</td>
                                            <td>$@item.Price.ToString("F2")</td>
                                            <td>
                                                <input type="number" 
                                                       name="quantities" 
                                                       id="quantity-@i"
                                                       class="form-control refund-quantity" 
                                                       min="0" 
                                                       max="@item.Quantity" 
                                                       value="0"
                                                       disabled
                                                       onchange="calculateTotal()" />
                                                <input type="hidden" class="product-id-input" id="productId-@i" value="@item.ProductId" />
                                            </td>
                                            <td>
                                                <span class="item-subtotal" id="subtotal-@i">$0.00</span>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot>
                                    <tr class="table-light">
                                        <td colspan="5" class="text-end fw-bold">Total Refund Amount:</td>
                                        <td class="fw-bold text-success">
                                            <span id="total-refund">$0.00</span>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <div class="mb-3">
                            <label for="reason" class="form-label">Reason for Refund (Optional)</label>
                            <textarea name="reason" id="reason" class="form-control" rows="3" 
                                      placeholder="Please provide a reason for your refund request..."></textarea>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> Back to Order Details
                            </a>
                            <button type="button" class="btn btn-warning" id="submit-btn" disabled onclick="submitRefundForm()">
                                <i class="bi bi-check-circle"></i> Submit Refund Request
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function updateRefundQuantity(checkbox, index) {
            const quantityInput = document.getElementById('quantity-' + index);
            if (checkbox.checked) {
                quantityInput.disabled = false;
                quantityInput.value = checkbox.dataset.quantity;
            } else {
                quantityInput.disabled = true;
                quantityInput.value = 0;
            }
            calculateTotal();
        }

        function calculateTotal() {
            let total = 0;
            const checkboxes = document.querySelectorAll('.refund-checkbox:checked');
            
            checkboxes.forEach(checkbox => {
                const index = Array.from(document.querySelectorAll('.refund-checkbox')).indexOf(checkbox);
                const quantityInput = document.getElementById('quantity-' + index);
                const quantity = parseInt(quantityInput.value) || 0;
                const price = parseFloat(checkbox.dataset.price);
                const subtotal = quantity * price;
                
                document.getElementById('subtotal-' + index).textContent = '$' + subtotal.toFixed(2);
                total += subtotal;
            });

            document.getElementById('total-refund').textContent = '$' + total.toFixed(2);
            
            // Enable submit button if at least one item is selected
            const submitBtn = document.getElementById('submit-btn');
            if (checkboxes.length > 0 && total > 0) {
                submitBtn.disabled = false;
            } else {
                submitBtn.disabled = true;
            }
        }

        // Update subtotals when quantities change
        document.querySelectorAll('.refund-quantity').forEach(input => {
            input.addEventListener('input', calculateTotal);
        });

        function submitRefundForm() {
            const form = document.getElementById('refundForm');
            const productIds = [];
            const quantities = [];
            
            // Collect only selected items with quantity > 0
            document.querySelectorAll('.refund-checkbox:checked').forEach(checkbox => {
                const index = Array.from(document.querySelectorAll('.refund-checkbox')).indexOf(checkbox);
                const quantityInput = document.getElementById('quantity-' + index);
                const quantity = parseInt(quantityInput.value) || 0;
                
                if (quantity > 0) {
                    const productIdInput = document.getElementById('productId-' + index);
                    productIds.push(productIdInput.value);
                    quantities.push(quantity);
                }
            });

            if (productIds.length === 0) {
                alert('Please select at least one product to refund.');
                return;
            }

            // Create hidden inputs for form submission
            productIds.forEach(id => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'productIds';
                input.value = id;
                form.appendChild(input);
            });

            quantities.forEach(qty => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'quantities';
                input.value = qty;
                form.appendChild(input);
            });

            // Submit the form
            form.submit();
        }
    </script>
}

